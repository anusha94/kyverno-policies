apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  annotations:
    policies.kyverno.io/category: Security
    policies.kyverno.io/description: This policy ensures that HTTP methods specified in AuthorizationPolicy resources are valid. The policy validates that methods defined in spec.rules[].to[].operation.method[] are from the allowed set of HTTP methods.
    policies.kyverno.io/severity: medium
    policies.kyverno.io/title: Validate Authorization Policy HTTP Methods
  name: validate-authz-policy-http-methods
spec:
  background: true
  rules:
      - match:
          any:
              - resources:
                  kinds:
                      - AuthorizationPolicy
        name: validate-http-methods
        validate:
          foreach:
            - deny:
                conditions:
                    all:
                      - key: '{{ element }}'
                        operator: NotIn
                        value:
                          - GET
                          - HEAD
                          - POST
                          - PUT
                          - DELETE
                          - CONNECT
                          - OPTIONS
                          - TRACE
                          - PATCH
              list: request.object.spec.rules[*].to[*].operation.methods[*]
          message: 'HTTP methods must be one of: GET, HEAD, POST, PUT, DELETE, CONNECT, OPTIONS, TRACE, PATCH'
  validationFailureAction: Enforce